# 点击上传图片

Created: September 17, 2021 11:52 AM
标签: JS, 上传, 图片

```jsx
async changeImage () {
			// 调用api打开文件选择器
      [fileHandle] = await window.showOpenFilePicker(this.pickerOpts)
			// 获取file图片数据
      const fileData = await fileHandle.getFile()
      let url = ''
			// 将图片转化blob格式
      if (window.createObjectURL !== undefined) {
        url = window.createObjectURL(fileData);
      } else if (window.URL !== undefined) {
        url = window.URL.createObjectURL(fileData);
      } else if (window.webkitURL !== undefined) {
        url = window.webkitURL.createObjectURL(fileData);
      }
      this.posterImage = url
}
<!--------------------------------------------------------------------------->
// 点击按钮上传图片
uploadFileBtn.addEventListener('click', async () => {
	// 限定上传文件类型
	const pickerOpts = {
		types: [
			{
				accept: {
									'image/*': ['.png', '.gif', '.jpeg', '.jpg', '.webp']
								}
			}
		],
		excludeAcceptAllOption: true,
		multiple: true
	}
	// 调用api打开文件选择器
  const fileHandle = await window.showOpenFilePicker(pickerOpts)
	// 获取图片数据
  let fileList = []
  for (const i of fileHandle) {
     const fileData = await i.getFile()
     fileList.push(fileData)
  }
	// 将图片转为base64
  toBase64(fileList, (data) => {
     imgListBox.appendChild(data)
  })
})
// 将图片转为base64
function toBase64 (file, callback) {
	let vm = document.createDocumentFragment(),
      loaded = 0, // 读取图片次数
      total = 0 // 存储总上传图片数量
  for (const e of file) {
     total ++ // 累计获取上传图片数量
     const imgFile = new FileReader()
     imgFile.readAsDataURL(e)
     imgFile.onload = (e) => {
       const img= document.createElement('img')
	     img.width = '100%'
       img.src = e.target.result
       vm.appendChild(img)
			 // 对比加载图片数量和上传图片数量
       if (++loaded === total) {
	       callback.call(this, vm)   
       }
     }
   }
 }
<!--------------------------------------------------------------------------->
// window.showOpenFilePicker 浏览器不支持时使用此方法
let a = document.createElement('input')
      a.type = 'file'
			a.accept = 'image/*'
      a.id = 'changeImage'
      let fileData = null
			// ***** 苹果手机无法上传图片 *****
			document.body.appendChild(a)
      let event = new MouseEvent('click')
      if( a.dispatchEvent(event)===true){
        a.addEventListener('change', (e) => {
          fileData = e.target.files[0]
          let url = ''
          if (window.createObjectURL !== undefined) {
            url = window.createObjectURL(fileData);
          } else if (window.URL !== undefined) {
            url = window.URL.createObjectURL(fileData);
          } else if (window.webkitURL !== undefined) {
            url = window.webkitURL.createObjectURL(fileData);
          }
          this.posterImage = url
        })
      }
      a.dispatchEvent(event)
    }
```