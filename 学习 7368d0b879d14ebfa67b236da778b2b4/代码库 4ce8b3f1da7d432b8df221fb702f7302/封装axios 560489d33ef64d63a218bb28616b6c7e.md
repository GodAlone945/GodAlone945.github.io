# 封装axios

Created: May 17, 2022 2:59 PM
标签: JS, axios

```jsx
import axios from 'axios'
import { Message, Loading } from 'element-ui'
import store from '../store/store'

let loadingInstance = null
let requestNum = 0

const addLoading = () => {
  // 增加loading 如果 pending请求数量等于1，弹出loading，防止重复弹出
  requestNum++
  if (requestNum === 1) {
    loadingInstance = Loading.service({
      text: '正在努力加载中...',
      background: 'rgba(0, 0, 0, 0)'
    })
  }
}

const cancelLoading = () => {
  // 取消loading 如果pending请求数量等于0，关闭loading
  requestNum--
  if (requestNum === 0) loadingInstance.close()
}

export const createAxiosByinterceptors = (config) => {
  const instance = axios.create({
    baseURL: store.state.baseURL, // 请求根路径
    // 请求头设置
    headers: {
      'Content-Type': 'application/json;charset=UTF-8'
    },
    timeout: 1000, // 超时配置
    ...config // 自定义配置覆盖级版本
  })
  // 请求拦截器
  instance.interceptors.request.use(
    function (config) {
      // 在请求发送之前做什么
      const { loading = true } = config
      console.log('config:', config)
      if (loading) addLoading()
      return config
    },
    function (error) {
      // 请求错误后做什么
      return Promise.reject(error)
    }
  )
  // 响应拦截器
  instance.interceptors.response.use(
    function (response) {
      // 对响应数据做点什么
      console.log('response:', response)
      const { loading = true } = response.config
      if (loading) cancelLoading()
      const { code, data, msg } = response.data
      if (code === 9000) return data
      else {
        Message.error({
          message: msg,
          offset: 250,
          customClass: 'messageClass'
        })
        return Promise.reject(response.data)
      }
    },
    function (error) {
      // 对响应错误做点什么
      console.log('error-response:', error.response)
      console.log('error-config:', error.config)
      console.log('error-request:', error.request)
      const { loading = true } = error.config()
      if (loading) cancelLoading()
      Message.error({
        message: error?.response?.data?.msg || '服务端异常',
        offset: 250,
        customClass: 'messageClass'
      })
      return Promise.reject(error)
    }
  )
  return instance
}
```